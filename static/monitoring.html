<!DOCTYPE html>
<html>
<head>
    <title>Pipeline Monitoring Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: #f5f5f5; padding: 20px; border-radius: 8px; }
        .metric { font-size: 2em; color: #333; }
        .refresh-btn { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üìä Data Pipeline Monitoring</h1>
    <button class="refresh-btn" onclick="refreshMetrics()">üîÑ Refresh Metrics</button>
    
    <div class="dashboard">
        <div class="card">
            <h3>üìà Processing Stats</h3>
            <div>Total Requests: <span id="total-requests" class="metric">0</span></div>
            <div>Average Latency: <span id="avg-latency" class="metric">0s</span></div>
        </div>
        
        <div class="card">
            <h3>üñ•Ô∏è GPU Usage</h3>
            <div>GPU Utilization: <span id="gpu-util" class="metric">0%</span></div>
            <div>GPU Memory: <span id="gpu-memory" class="metric">0 MB</span></div>
        </div>
        
        <div class="card">
            <h3>üìä Pipeline Status</h3>
            <canvas id="pipelineChart" width="400" height="200"></canvas>
        </div>
        
        <div class="card">
            <h3>üíæ Storage Status</h3>
            <div id="storage-stats">Loading...</div>
        </div>
    </div>

    <script>
        let chart;
        
        async function refreshMetrics() {
            try {
                // Get Prometheus metrics
                const metricsResponse = await fetch('/metrics');
                const metricsText = await metricsResponse.text();
                
                // Parse metrics (basic parsing)
                const requestsMatch = metricsText.match(/invoice_extract_requests_total (\d+)/);
                const latencyMatch = metricsText.match(/invoice_extract_request_duration_seconds_sum (\d+\.?\d*)/);
                const gpuUtilMatch = metricsText.match(/gpu_utilization_percentage (\d+\.?\d*)/);
                const gpuMemMatch = metricsText.match(/gpu_memory_used_bytes (\d+)/);
                
                // Update UI
                document.getElementById('total-requests').textContent = requestsMatch ? requestsMatch[1] : '0';
                document.getElementById('avg-latency').textContent = latencyMatch ? (parseFloat(latencyMatch[1])).toFixed(2) + 's' : '0s';
                document.getElementById('gpu-util').textContent = gpuUtilMatch ? gpuUtilMatch[1] + '%' : '0%';
                document.getElementById('gpu-memory').textContent = gpuMemMatch ? (parseInt(gpuMemMatch[1]) / 1024 / 1024).toFixed(0) + ' MB' : '0 MB';
                
                // Get invoice data
                const invoicesResponse = await fetch('/invoices');
                const invoices = await invoicesResponse.json();
                
                updatePipelineChart(invoices);
                updateStorageStats();
                
            } catch (error) {
                console.error('Error fetching metrics:', error);
            }
        }
        
        function updatePipelineChart(invoices) {
            const ctx = document.getElementById('pipelineChart').getContext('2d');
            
            // Count invoices by status
            const statusCounts = {
                'Success': 0,
                'Warnings': 0,
                'Failed': 0
            };
            
            invoices.forEach(invoice => {
                // This is a simplified status determination
                if (invoice.total_amount) statusCounts['Success']++;
                else statusCounts['Failed']++;
            });
            
            if (chart) chart.destroy();
            
            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#28a745', '#ffc107', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
        
        async function updateStorageStats() {
            // This would ideally connect to MinIO API
            // For now, show placeholder data
            document.getElementById('storage-stats').innerHTML = `
                <div>Raw Invoices: Loading...</div>
                <div>OCR Files: Loading...</div>
                <div>LLM Output: Loading...</div>
                <div>Cleaned Data: Loading...</div>
            `;
        }
        
        // Auto-refresh every 30 seconds
        setInterval(refreshMetrics, 30000);
        
        // Initial load
        refreshMetrics();
    </script>
</body>
</html>